root = global ? window
angular = root.angular

thisApp = angular.module("ToptalTodolist", ['ngResource', 'ngCookies', 'tasks']).config(['$routeProvider', '$locationProvider' , 
($routeProvider, $locationProvider) ->
  $locationProvider.html5Mode true
  $routeProvider
  .when('/register',
    controller: 'UsersCtrl'
    templateUrl: '<%= asset_path "registrations/new.html" %>'
  ).when('/login',
    controller: 'UsersCtrl'
    templateUrl: '<%= asset_path "sessions/new.html" %>'
  ).when("/tasks",
    controller: TasksIndexCtrl
    templateUrl: '<%= asset_path "tasks/index.html" %>'
  ).when("/tasks/new",
    controller: TasksCreateCtrl
    templateUrl: '<%= asset_path "tasks/new.html" %>'
  ).when("/tasks/:id",
    controller: TasksShowCtrl
    templateUrl: '<%= asset_path "tasks/show.html" %>'
  ).when("/tasks/:id/edit",
    controller: TasksEditCtrl
    templateUrl: '<%= asset_path "tasks/edit.html" %>'
  ).otherwise redirectTo: "/tasks"
])

thisApp.run(($rootScope, $location) ->
  $rootScope.$on('$routeChangeStart', (event, next, current) ->
    if ($location.path() != '/login' && $location.path() != '/register' && !$rootScope.authorized())
      $location.path('/register')
    else if (($location.path() == '/login' || $location.path() == '/register') && $rootScope.authorized())
      $location.path('/')
  )
)

root.thisApp = thisApp
